import hilog from '@ohos.hilog';
import { ContextLabel, ProjectLabel, TaskItem } from '../common/CommonBuilders';
import { Constants } from '../common/Constants';
import { formatDateToChinese, overDue } from '../common/utils';
import { ContextModel, ProjectModel, TaskModel } from '../models/IModels';
import { GTDController } from '../viewmodel/GTDController';

@Component
export struct InboxView {
  @Link tasks: TaskModel[];
  @State projects: ProjectModel[]|null = null;
  @Consume gtdController: GTDController;
  @Consume currentEditingTask: TaskModel;
  @Consume isPopupVisible: boolean;
  @State showCompletedTasks: boolean = false


  aboutToAppear(){
  }


  async loadTasks() {
    try {
      this.tasks = await this.gtdController.getAllTasks();
      hilog.debug(0x001,'tasksload',`tasksload:  ${JSON.stringify(this.tasks)}`)


    } catch (error) {
      console.error('Failed to load tasks:', error);
    }
    this.gtdController.initializeCache()
  }



  @Builder ProjectMenuBuilder() {
    Menu() {

      MenuItem({ content: 'æ— é¡¹ç›®' })
        .onClick(async () => {
          // this.selectedProject = { id: -1, name : '' }
          this.currentEditingTask.projectId = -1
          await this.gtdController.updateTask(this.currentEditingTask)
          // è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…é™¤é€‰æ‹©åŽçš„é€»è¾‘
        })

      // ForEach(Object.values(this.gtdController.projectCache), (project: ProjectModel) => {
      ForEach(Object.values(this.gtdController.projectCache).sort((a, b) => a.name.localeCompare(b.name)), (project: ProjectModel) => {
        MenuItem({ content: project.name })
          .onClick(async () => {
            // this.selectedProject = project
            this.currentEditingTask.projectId = project.id
            await this.gtdController.updateTask(this.currentEditingTask)
            // è¿™é‡Œå¯ä»¥æ·»åŠ é€‰æ‹© context åŽçš„é€»è¾‘ï¼Œæ¯”å¦‚æ›´æ–°ä»»åŠ¡çš„ context
          })

      })
    }
  }
  @Builder contextMenuBuilder() {
    Menu() {
      MenuItem({ content: 'æ— åœºæ™¯' })
        .onClick(async () => {
          // this.selectedContext = { id: -1, name : '' }
          this.currentEditingTask.contextId = -1
          await this.gtdController.updateTask(this.currentEditingTask)
          // è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…é™¤é€‰æ‹©åŽçš„é€»è¾‘
        })

      ForEach(Object.values(this.gtdController.contextCache), (context: ContextModel) => {
        MenuItem({ content: context.name })
          .onClick(async () => {
            // this.selectedContext = context
            this.currentEditingTask.contextId = context.id
            await this.gtdController.updateTask(this.currentEditingTask)
            // è¿™é‡Œå¯ä»¥æ·»åŠ é€‰æ‹© context åŽçš„é€»è¾‘ï¼Œæ¯”å¦‚æ›´æ–°ä»»åŠ¡çš„ context
          })

      })
    }
  }
  @Builder itemEnd(record: TaskModel) {
    Row() {
      Button({ type: ButtonType.Normal }) {
        Text('é¡¹ç›®')
          .fontColor(Color.White)
          .width(40)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.editButtonColor)
      .onClick(() => {
        this.currentEditingTask = record;
      })
      .margin({right:1})
      .bindMenu(this.ProjectMenuBuilder)

      Button({ type: ButtonType.Normal }) {
        Text('åœºæ™¯')
          .fontColor(Color.White)
          .width(40)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.editButtonColor)
      .onClick(() => {
        this.currentEditingTask = record;
      })
      .margin({right:1})
      .bindMenu(this.contextMenuBuilder)


      Button({ type: ButtonType.Normal }) {
        Text('EDIT')
          .fontColor(Color.White)
          .width(40)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.editButtonColor)
      .onClick(() => {
        this.currentEditingTask = record;
        this.isPopupVisible = true;
        // this.loadTasks()
      })
      .margin({right:1})
      // ä¾§æ»‘åŽå°¾ç«¯å‡ºçŽ°çš„ç»„ä»¶
      Button({ type: ButtonType.Normal }) {
        Text('DEL')
          .fontColor(Color.White)
          .width(40)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.deleteButtonColor)
      .onClick(async () => {
        // this.controller.deleteMoodRecord(record.id)
        await this.gtdController.deleteTask(record.id)
        // this.loadTasks()

      })

    }
  }

  @Builder itemStart(record: TaskModel) {
    Row() {

      Button({ type: ButtonType.Normal }) {
        Text(record.flagged ? '-ðŸŒŸ' : 'ðŸŒŸ' )
          .fontColor(Color.White)
          .width(45)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.deleteButtonColor)
      .onClick(async () => {
        // this.controller.deleteMoodRecord(record.id)
        this.currentEditingTask = record;
        this.currentEditingTask.flagged = !this.currentEditingTask.flagged
        await this.gtdController.updateTask(this.currentEditingTask)

      })
      Button({ type: ButtonType.Normal }) {
        Text('0d')
          .fontColor(Color.White)
          .width(45)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.editButtonColor)
      .margin({right:1})
      .onClick(() => {
        this.currentEditingTask = record;
        const today = new Date()
        this.currentEditingTask.dueDate = today
        this.currentEditingTask.dueDate.setDate(today.getDate() + 0)
        this.gtdController.updateTask(this.currentEditingTask)
      })

      Button({ type: ButtonType.Normal }) {
        Text('+1d')
          .fontColor(Color.White)
          .width(45)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.editButtonColor)
      .margin({right:1})

      .onClick(() => {
        this.currentEditingTask = record;
        const today = new Date()
        this.currentEditingTask.dueDate = today
        this.currentEditingTask.dueDate.setDate(today.getDate() + 1)
        this.gtdController.updateTask(this.currentEditingTask)
      })
      Button({ type: ButtonType.Normal }) {
        Text('+7d')
          .fontColor(Color.White)
          .width(45)
          .height('80%')
          .textAlign(TextAlign.Center)
      }
      .backgroundColor(Constants.editButtonColor)
      .margin({right:1})

      .onClick(() => {
        this.currentEditingTask = record;
        const today = new Date()
        this.currentEditingTask.dueDate = today
        this.currentEditingTask.dueDate.setDate(today.getDate() + 7)
        this.gtdController.updateTask(this.currentEditingTask)
      })



    }
  }







  build() {
    Column() {
      List() {
        ForEach(this.tasks
          .filter(task => !task.isCompleted && (task.projectId == null || task.projectId == undefined || task.projectId == -1)),
          (task: TaskModel, index: number) => {
            ListItem() {
              TaskItem(task, this.gtdController, () => this.loadTasks())
            }
            .swipeAction({ end: this.itemEnd(task), start: this.itemStart(task) })
          }
        )
      }
      .width('100%')

      // Divider()
      //   .strokeWidth(0.5)
      //   .width('90%')
      //   .margin({top:10, bottom:10})


      // æ·»åŠ ä¸€ä¸ªæŒ‰é’®æ¥æŽ§åˆ¶å·²å®Œæˆä»»åŠ¡çš„æ˜¾ç¤º/éšè—
      Button({ type: ButtonType.Normal, stateEffect: true }){
        Text(this.showCompletedTasks ? 'æ˜¾ç¤ºå·²å®Œæˆä»»åŠ¡' : 'éšè—å·²å®Œæˆä»»åŠ¡')
          .fontSize(16)
          .fontColor(this.showCompletedTasks ? Color.White : Color.Gray)
          .padding(5)
      }
      .height(30)
      .backgroundColor(this.showCompletedTasks ? '#ff343434' : '#ff343434')
      .borderRadius(5)
      .align(Alignment.Start)
      .alignSelf(ItemAlign.Start)
      .onClick(() => {
        this.showCompletedTasks = !this.showCompletedTasks;
      })
      .margin({ bottom: 10 })



      if(this.showCompletedTasks) {
        List() {
          ForEach(this.tasks
            .filter(task => task.isCompleted && !!task.projectId)
            .sort((a, b) => new Date(b.modifyTime).getTime() - new Date(a.modifyTime).getTime()),
            (task: TaskModel, index: number) => {
              ListItem() {
                TaskItem(task, this.gtdController, () => this.loadTasks())
              }
              .swipeAction({ end: this.itemEnd(task), start: this.itemStart(task) })
            })
        }
        .width('100%')
      }
    }

  }
}


